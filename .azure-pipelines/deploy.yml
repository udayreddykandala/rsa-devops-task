trigger:
- main

pool:
  name: 'MyAgentPool'   # âœ… your self-hosted agent pool

variables:
  octopus_space: 'default'
  octopus_environment: 'Dev'
  octopus_roles: 'web'

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform with CLI"
    steps:
    - checkout: self

    - script: |
        echo "Installing Terraform..."
        curl -o terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_darwin_arm64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -version
      displayName: "Install Terraform"

    - script: |
        terraform init -input=false
      displayName: "Terraform Init"

    - script: |
        terraform plan \
          -var "octopus_space=$(octopus_space)" \
          -var "octopus_environment=$(octopus_environment)" \
          -var "octopus_roles=$(octopus_roles)" \
          -out=tfplan
      displayName: "Terraform Plan"

    - script: |
        terraform apply -auto-approve tfplan
      displayName: "Terraform Apply"

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusJob
    displayName: "Deploy via Octopus CLI"
    steps:
    - script: |
        echo "Installing Octopus CLI..."
        curl -s https://octopus.com/downloads/latest/OctopusTools/macos-x64 -L -o octo.tar.gz
        mkdir octo-cli && tar xzf octo.tar.gz -C octo-cli --strip-components=1
        sudo mv octo-cli/octo /usr/local/bin/

        echo "Creating Octopus Release..."
        octo create-release \
          --project="MyProject" \
          --releaseNumber="1.0.$(Build.BuildId)" \
          --server="$(OCTOPUS_HOST)" \
          --apiKey="$(OCTOPUS_APIKEY)" \
          --space "$(octopus_space)" \
          --deployTo "$(octopus_environment)"
      displayName: "Octopus Deploy"
