trigger:
- main

pool:
  name: MyAgentPool

stages:
# =============================
# Stage 1: Terraform
# =============================
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - checkout: self

    # Install Terraform (latest ARM64 build for macOS/Linux agent)
    - task: CmdLine@2
      displayName: "Install Terraform"
      inputs:
        script: |
          curl -LO https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_darwin_arm64.zip
          unzip terraform_1.5.7_darwin_arm64.zip
          sudo mv terraform /usr/local/bin/

    # Terraform Init
    - task: TerraformCLI@1
      displayName: "Terraform Init"
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
        environmentServiceName: 'azure-rm-conn'

    # Terraform Plan with vars
    - task: TerraformCLI@1
      displayName: "Terraform Plan"
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
        environmentServiceName: 'azure-rm-conn'
        commandOptions: >
          -var "octopus_space=Demo"
          -var "octopus_environment=Prod"
          -var "octopus_roles=[\"web\"]"

    # Terraform Apply with vars
    - task: TerraformCLI@1
      displayName: "Terraform Apply"
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
        environmentServiceName: 'azure-rm-conn'
        commandOptions: >
          -auto-approve
          -var "octopus_space=Demo"
          -var "octopus_environment=Prod"
          -var "octopus_roles=[\"web\"]"

# =============================
# Stage 2: Octopus Deployment
# =============================
- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusDeploy
    displayName: "Deploy via Octopus"
    steps:
    - task: OctopusCreateRelease@4
      displayName: "Create Octopus Release"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: 'Demo'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'
        DeployTo: 'Prod'
