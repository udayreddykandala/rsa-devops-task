trigger:
  branches:
    include:
      - main

pool:
  name: MyAgentPool   # self-hosted agent you set up on Mac

variables:
  - group: rsa-devops-vars

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform with Bash"
    steps:
    - script: |
        echo "Installing Terraform..."
        brew install terraform || true
        terraform -version
      displayName: "Install Terraform"

    - script: |
        cd infra
        terraform init
      displayName: "Terraform Init"

    - script: |
        cd infra
        terraform plan \
          -var "azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
          -var "admin_password=$(ADMIN_PASSWORD)" \
          -var "allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var "octopus_url=$(OCTOPUS_URL)" \
          -var "octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var "alert_email=$(ALERT_EMAIL)" \
          -var "octopus_space=Demo" \
          -var "octopus_environment=Prod" \
          -var "octopus_roles=web"
      displayName: "Terraform Plan"

    - script: |
        cd infra
        terraform apply -auto-approve \
          -var "azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
          -var "admin_password=$(ADMIN_PASSWORD)" \
          -var "allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var "octopus_url=$(OCTOPUS_URL)" \
          -var "octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var "alert_email=$(ALERT_EMAIL)" \
          -var "octopus_space=Demo" \
          -var "octopus_environment=Prod" \
          -var "octopus_roles=web"
      displayName: "Terraform Apply"

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusDeploy
    displayName: "Deploy via Octopus"
    steps:
    - task: OctopusCreateRelease@4
      displayName: "Create Octopus Release"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: 'Demo'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'
        DeployTo: 'Prod'
