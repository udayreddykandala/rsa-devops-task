trigger:
  branches:
    include:
      - main

pool:
  name: MyAgentPool   # ðŸ‘ˆ use your self-hosted agent pool name

variables:
  - group: rsa-devops-vars

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - script: |
        echo "##vso[task.prependpath]/usr/local/bin"
        terraform -version
      displayName: "Verify Terraform Installed"

    - task: CmdLine@2
      displayName: "Terraform Init"
      inputs:
        script: terraform init -input=false
        workingDirectory: infra

    - task: CmdLine@2
      displayName: "Terraform Plan"
      inputs:
        script: |
          terraform plan -input=false \
            -var="azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
            -var="admin_password=$(ADMIN_PASSWORD)" \
            -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
            -var="octopus_url=$(OCTOPUS_URL)" \
            -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
            -var="alert_email=$(ALERT_EMAIL)" \
            -var="github_owner=udayreddykandala" \
            -var="github_repo=rsa-devops-task" \
            -var="github_branch=main" \
            -var="octopus_space=Demo" \
            -var="octopus_environment=Prod" \
            -var='octopus_roles=["web"]'
        workingDirectory: infra

    - task: CmdLine@2
      displayName: "Terraform Apply"
      inputs:
        script: |
          terraform apply -auto-approve \
            -var="azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
            -var="admin_password=$(ADMIN_PASSWORD)" \
            -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
            -var="octopus_url=$(OCTOPUS_URL)" \
            -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
            -var="alert_email=$(ALERT_EMAIL)" \
            -var="github_owner=udayreddykandala" \
            -var="github_repo=rsa-devops-task" \
            -var="github_branch=main" \
            -var="octopus_space=Demo" \
            -var="octopus_environment=Prod" \
            -var='octopus_roles=["web"]'
        workingDirectory: infra

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusDeploy
    displayName: "Deploy via Octopus"
    steps:
    - task: OctopusCreateRelease@4
      displayName: "Create Octopus Release"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: 'Demo'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'
        DeployTo: 'Prod'
