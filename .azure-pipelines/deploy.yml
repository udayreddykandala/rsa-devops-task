trigger:
- main

pool:
  name: MyAgentPool

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform locally"
    steps:
    - checkout: self

    # Install Terraform (latest)
    - task: TerraformInstaller@0
      displayName: "Install Terraform"
      inputs:
        terraformVersion: 'latest'

    # Terraform Init (LOCAL backend, no Azure storage account)
    - task: TerraformCLI@0
      displayName: "Terraform Init"
      inputs:
        command: 'init'
        workingDirectory: 'infra'

    # Terraform Plan
    - task: TerraformCLI@0
      displayName: "Terraform Plan"
      inputs:
        command: 'plan'
        workingDirectory: 'infra'
        environmentServiceName: 'azure-rm-conn'
        commandOptions: |
          -var "admin_username=udayadmin" \
          -var "admin_password=MyStrongPassw0rd!" \
          -var "octopus_space=Demo" \
          -var "octopus_environment=Prod" \
          -var "octopus_roles=web"

    # Terraform Apply (auto approve)
    - task: TerraformCLI@0
      displayName: "Terraform Apply"
      inputs:
        command: 'apply'
        workingDirectory: 'infra'
        environmentServiceName: 'azure-rm-conn'
        commandOptions: |
          -auto-approve \
          -var "admin_username=udayadmin" \
          -var "admin_password=MyStrongPassw0rd!" \
          -var "octopus_space=Demo" \
          -var "octopus_environment=Prod" \
          -var "octopus_roles=web"
