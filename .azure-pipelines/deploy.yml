trigger:
  branches:
    include:
      - main

pool:
  name: MyAgentPool   # use your self-hosted pool

variables:
  - group: rsa-devops-vars

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - script: |
        terraform -version
      displayName: "Check Terraform version"

    - script: |
        cd infra
        terraform init
      displayName: "Terraform Init"

    - script: |
        cd infra
        terraform plan -input=false \
          -var="admin_password=$(ADMIN_PASSWORD)" \
          -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var="octopus_url=$(OCTOPUS_URL)" \
          -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var="alert_email=$(ALERT_EMAIL)" \
          -var="github_owner=udayreddykandala" \
          -var="github_repo=rsa-devops-task" \
          -var="github_branch=main" \
          -var="octopus_space=Demo" \
          -var="octopus_environment=Prod" \
          -var="octopus_roles=web"
      displayName: "Terraform Plan"

    - script: |
        cd infra
        terraform apply -input=false -auto-approve \
          -var="admin_password=$(ADMIN_PASSWORD)" \
          -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var="octopus_url=$(OCTOPUS_URL)" \
          -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var="alert_email=$(ALERT_EMAIL)" \
          -var="github_owner=udayreddykandala" \
          -var="github_repo=rsa-devops-task" \
          -var="github_branch=main" \
          -var="octopus_space=Demo" \
          -var="octopus_environment=Prod" \
          -var="octopus_roles=web"
      displayName: "Terraform Apply"

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusJob
    displayName: "Octopus Deployment"
    steps:
    - script: |
        echo "Installing Octopus CLI..."
        curl -s https://octopus.com/downloads/latest/octopuscli -o octo.tar.gz
        mkdir octo
        tar xzf octo.tar.gz -C octo --strip-components=1
        sudo mv octo/octo /usr/local/bin/
        octo version
      displayName: "Install Octopus CLI"

    - script: |
        octo create-release \
          --server "$(OCTOPUS_URL)" \
          --apiKey "$(OCTOPUS_API_KEY)" \
          --project "rsa-devops-task" \
          --space "Demo" \
          --deployTo "Prod" \
          --releaseNumber "1.0.$(Build.BuildId)"
      displayName: "Create and Deploy Octopus Release"
