trigger:
  branches:
    include:
      - main

pool:
  name: MyAgentPool

variables:
  - group: rsa-devops-vars

stages:
# Terraform Stage
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - script: terraform --version
      displayName: "Check Terraform Version"

    - script: terraform init
      displayName: "Terraform Init"
      workingDirectory: infra

    - script: terraform plan -input=false -out=tfplan
      displayName: "Terraform Plan"
      workingDirectory: infra

    - script: terraform apply -input=false -auto-approve tfplan
      displayName: "Terraform Apply"
      workingDirectory: infra

# Octopus Deploy Stage
- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusJob
    displayName: "Octopus Deployment"
    steps:
    - task: OctopusPush@4
      displayName: "Push package to Octopus"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: '$(octopus_space)'
        Package: '**/*.zip'

    - task: OctopusCreateRelease@4
      displayName: "Create Release in Octopus"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: '$(octopus_space)'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'

    - task: OctopusDeployRelease@4
      displayName: "Deploy Release to Prod"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: '$(octopus_space)'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'
        DeployTo: 'Prod'
