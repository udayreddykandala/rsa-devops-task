trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # GitHub
  github_owner: 'udayreddy2451'
  github_repo: 'rsa-devops-task'
  github_branch: 'main'

  # Octopus
  octopus_space: 'Default'
  octopus_environment: 'Development'
  octopus_roles: '["web","app"]'
  octopus_url: 'https://udayreddykandala.octopus.app'
  octopus_api_key: '$(OctopusApiKey)'   # Secure variable (set in Azure DevOps Library)

  # Alerts
  alert_email: 'udayreddy2451@gmail.com'

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Terraform Plan & Apply"
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: '1.6.6'

    - script: |
        terraform init \
          -backend-config="resource_group_name=rg-devops-task" \
          -backend-config="storage_account_name=rsadevopsstorageuday" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=terraform.tfstate"
      displayName: Terraform Init

    - script: |
        terraform plan \
          -var="github_owner=$(github_owner)" \
          -var="github_repo=$(github_repo)" \
          -var="github_branch=$(github_branch)" \
          -var="octopus_space=$(octopus_space)" \
          -var="octopus_environment=$(octopus_environment)" \
          -var='octopus_roles=$(octopus_roles)' \
          -var="octopus_url=$(octopus_url)" \
          -var="octopus_api_key=$(octopus_api_key)" \
          -var="alert_email=$(alert_email)"
      displayName: Terraform Plan

    - script: |
        terraform apply -auto-approve \
          -var="github_owner=$(github_owner)" \
          -var="github_repo=$(github_repo)" \
          -var="github_branch=$(github_branch)" \
          -var="octopus_space=$(octopus_space)" \
          -var="octopus_environment=$(octopus_environment)" \
          -var='octopus_roles=$(octopus_roles)' \
          -var="octopus_url=$(octopus_url)" \
          -var="octopus_api_key=$(octopus_api_key)" \
          -var="alert_email=$(alert_email)"
      displayName: Terraform Apply
