trigger:
- main

pool:
  name: MyAgentPool

variables:
  terraformVersion: '1.5.7'

stages:
- stage: Terraform
  displayName: "Terraform Stage"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform CLI"
    pool:
      name: MyAgentPool
    steps:
    - script: |
        echo "Installing Terraform $(terraformVersion)"
        curl -sLo terraform.zip https://releases.hashicorp.com/terraform/${terraformVersion}/terraform_${terraformVersion}_darwin_arm64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -version
      displayName: "Install Terraform"

    - script: |
        cd infra
        terraform init -input=false
      displayName: "Terraform Init"

    - script: |
        cd infra
        terraform plan -input=false -out=tfplan \
          -var "octopus_space=$(octopus_space)" \
          -var "octopus_environment=$(octopus_environment)" \
          -var "octopus_roles=$(octopus_roles)"
      displayName: "Terraform Plan"

    - script: |
        cd infra
        terraform apply -input=false -auto-approve tfplan
      displayName: "Terraform Apply"

- stage: Octopus
  displayName: "Octopus Stage"
  dependsOn: Terraform
  jobs:
  - job: OctopusJob
    pool:
      name: MyAgentPool
    steps:
    - script: |
        echo "Installing Octopus CLI"
        curl -L https://download.octopus.com/octopus-tools/9.1.7/OctopusTools.9.1.7.osx-x64.tar.gz -o octo.tar.gz
        mkdir octo && tar -xzf octo.tar.gz -C octo --strip-components=1
        sudo mv octo/octo /usr/local/bin/
        octo version
      displayName: "Install Octopus CLI"

    - script: |
        echo "Pushing package to Octopus..."
        octo push \
          --server "$(OCTOPUS_URL)" \
          --apiKey "$(OCTOPUS_API_KEY)" \
          --space "$(octopus_space)" \
          --package "$(Build.ArtifactStagingDirectory)/**/*.zip"
      displayName: "Octopus Push Package"

    - script: |
        echo "Creating release..."
        octo create-release \
          --server "$(OCTOPUS_URL)" \
          --apiKey "$(OCTOPUS_API_KEY)" \
          --space "$(octopus_space)" \
          --project "rsa-devops-task" \
          --releaseNumber "1.0.$(Build.BuildId)"
      displayName: "Octopus Create Release"

    - script: |
        echo "Deploying release..."
        octo deploy-release \
          --server "$(OCTOPUS_URL)" \
          --apiKey "$(OCTOPUS_API_KEY)" \
          --space "$(octopus_space)" \
          --project "rsa-devops-task" \
          --releaseNumber "1.0.$(Build.BuildId)" \
          --deployTo "$(octopus_environment)"
      displayName: "Octopus Deploy Release"
