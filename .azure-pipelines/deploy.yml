trigger:
- main

pool:
  name: MyAgentPool   # Use your self-hosted agent pool

variables:
# ðŸ”¹ Pull secrets from variable group
- group: rsa-devops-vars   

# ðŸ”¹ Terraform version
- name: terraformVersion
  value: '1.5.7'

# ðŸ”¹ GitHub repo info
- name: github_owner
  value: "udayreddy2451"
- name: github_repo
  value: "rsa-devops-task"
- name: github_branch
  value: "main"

# ðŸ”¹ Octopus Deploy info
- name: octopus_space
  value: "Demo"
- name: octopus_environment
  value: "Prod"
- name: octopus_roles
  value: "web"

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - script: |
        echo "Installing Terraform $(terraformVersion)"
        curl -sLo terraform.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_darwin_arm64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform version
      displayName: "Install Terraform"

    - script: |
        terraform init
      workingDirectory: infra
      displayName: "Terraform Init"

    - script: |
        terraform plan \
          -var="azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
          -var="admin_password=$(ADMIN_PASSWORD)" \
          -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var="octopus_url=$(OCTOPUS_URL)" \
          -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var="alert_email=$(ALERT_EMAIL)" \
          -var="github_owner=$(github_owner)" \
          -var="github_repo=$(github_repo)" \
          -var="github_branch=$(github_branch)" \
          -var="octopus_space=$(octopus_space)" \
          -var="octopus_environment=$(octopus_environment)" \
          -var="octopus_roles=$(octopus_roles)"
      workingDirectory: infra
      displayName: "Terraform Plan"

    - script: |
        terraform apply -auto-approve \
          -var="azure_subscription_id=$(AZURE_SUBSCRIPTION_ID)" \
          -var="admin_password=$(ADMIN_PASSWORD)" \
          -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var="octopus_url=$(OCTOPUS_URL)" \
          -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var="alert_email=$(ALERT_EMAIL)" \
          -var="github_owner=$(github_owner)" \
          -var="github_repo=$(github_repo)" \
          -var="github_branch=$(github_branch)" \
          -var="octopus_space=$(octopus_space)" \
          -var="octopus_environment=$(octopus_environment)" \
          -var="octopus_roles=$(octopus_roles)"
      workingDirectory: infra
      displayName: "Terraform Apply"

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusJob
    displayName: "Deploy via Octopus"
    steps:
    - script: |
        echo "Pushing package to Octopus..."
        echo "## Octopus CLI should be installed separately"
      displayName: "Octopus Deploy Placeholder"
