trigger:
- main

parameters:
- name: tf_action
  type: string
  default: init
  values:
  - init
  - plan
  - apply

pool:
  name: MyAgentPool

variables:
  - group: rsa-devops-vars   # has ADMIN_PASSWORD, ALLOWED_RDP_CIDR, OCTOPUS_URL, OCTOPUS_API_KEY, ALERT_EMAIL

steps:
- checkout: self

# Install Terraform locally (no sudo, no extensions)
- script: |
    set -e
    mkdir -p $(Pipeline.Workspace)/tfbin
    curl -sLo $(Pipeline.Workspace)/tfbin/terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_darwin_arm64.zip
    unzip -o $(Pipeline.Workspace)/tfbin/terraform.zip -d $(Pipeline.Workspace)/tfbin
    echo "##vso[task.prependpath]$(Pipeline.Workspace)/tfbin"
    terraform -version
  displayName: "Install Terraform"

# terraform init
- ${{ if eq(parameters.tf_action, 'init') }}:
  - script: |
      set -e
      terraform -chdir=infra init -input=false
    displayName: "terraform init"

# terraform plan
- ${{ if eq(parameters.tf_action, 'plan') }}:
  - script: |
      set -e
      terraform -chdir=infra plan -input=false -out=tfplan \
        -var="admin_password=$(ADMIN_PASSWORD)" \
        -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
        -var="octopus_url=$(OCTOPUS_URL)" \
        -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
        -var="alert_email=$(ALERT_EMAIL)" \
        -var="github_owner=udayreddykandala" \
        -var="github_repo=rsa-devops-task" \
        -var="github_branch=main" \
        -var="octopus_space=Demo" \
        -var="octopus_environment=Prod" \
        -var='octopus_roles=["web"]'
    displayName: "terraform plan"

# terraform apply
- ${{ if eq(parameters.tf_action, 'apply') }}:
  - script: |
      set -e
      # Prefer saved plan if present
      if [ -f infra/tfplan ]; then
        terraform -chdir=infra apply -input=false -auto-approve tfplan
      else
        terraform -chdir=infra apply -input=false -auto-approve \
          -var="admin_password=$(ADMIN_PASSWORD)" \
          -var="allowed_rdp_cidr=$(ALLOWED_RDP_CIDR)" \
          -var="octopus_url=$(OCTOPUS_URL)" \
          -var="octopus_api_key=$(OCTOPUS_API_KEY)" \
          -var="alert_email=$(ALERT_EMAIL)" \
          -var="github_owner=udayreddykandala" \
          -var="github_repo=rsa-devops-task" \
          -var="github_branch=main" \
          -var="octopus_space=Demo" \
          -var="octopus_environment=Prod" \
          -var='octopus_roles=["web"]'
      fi
    displayName: "terraform apply"
