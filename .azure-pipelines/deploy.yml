trigger:
  branches:
    include:
      - main

pool:
  name: MyAgentPool   # your self-hosted agent pool

variables:
  - group: rsa-devops-vars

stages:
- stage: Terraform
  displayName: "Terraform Infrastructure"
  jobs:
  - job: TerraformJob
    displayName: "Run Terraform"
    steps:
    - script: |
        curl -LO https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_darwin_arm64.zip
        unzip terraform_1.5.7_darwin_arm64.zip
        sudo mv terraform /usr/local/bin/
        terraform version
      displayName: "Install Terraform"

    - script: terraform init
      workingDirectory: infra
      displayName: "Terraform Init"

    - script: terraform plan -input=false -out=tfplan
      workingDirectory: infra
      displayName: "Terraform Plan"

    - script: terraform apply -input=false -auto-approve tfplan
      workingDirectory: infra
      displayName: "Terraform Apply"

- stage: Deploy
  displayName: "Deploy to Octopus"
  dependsOn: Terraform
  jobs:
  - job: OctopusDeploy
    displayName: "Deploy via Octopus"
    steps:
    - task: OctopusCreateRelease@4
      displayName: "Create Octopus Release"
      inputs:
        OctoConnectedServiceName: 'octopus-conn'
        Space: 'Demo'
        Project: 'rsa-devops-task'
        ReleaseNumber: '1.0.$(Build.BuildId)'
        DeployTo: 'Prod'
